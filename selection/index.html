<!DOCTYPE html>
<html lang=en>
<head>
<meta charset="utf-8">
<title>Text Selection</title>
<link rel="stylesheet" href="../css/core.css" />
<link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
</head>

<body>
  <div class="sidebar">
    <div class="logo">
      <a href="../"><img src="../img/logo.png" alt="openbook home" /></a>
    </div>

    <nav>
      <ol>
        <li><a href="#top">Overview</a></li>
        <li><a href="#intro">Introduction</a></li>
        <li><a href="#discover">Discovering Selections</a></li>
        <li><a href="#hyphens">Hyphenated words</a></li>
        <li><a href="#jump">Jump to next word</a></li>
        <li><a href="#box">Limiting to one element</a></li>
        <li><a href="#end">Conclusion</a></li>
      </ol>
    </nav>

    <p class="aside support">If you have any difficulty in this tutorial, please <a href="https://github.com/lexogram/openbook/issues/new">tell us about it</a>, and we will do our best to deal with it for you.</p>
  </div>

<main>
<header>
  <a href="https://github.com/lexogram/openbook/blob/master/LICENSE" class="cc">&#59409;</a>
  <h1>Text Selection</h1>
  <ul class="nav">
    <li>
      <a href="#back"><img src="../img/arrow.png" alt="back" /></a>
    </li><li>
      <a href="#next"><img src="../img/arrow.png" alt="next" /></a>
    </li>
  </ul>
</header>

<article>
<!-- INTRODUCTION -->
<section id="intro">
  <h2>Introduction</h2>
  <p>More details to go here</p>

  <footer>
    <ul class="nav">
      <li>
        <a href="#end">
          <img src="../img/arrow.png" alt="next"/>
        </a>
      </li>
    </ul>
  </footer>
</section>

<!-- DISCOVER -->
<section id="discover">
  <h2>Discovering the <code>Selection</code> and <code>Range</code> objects</h2>
  <div class="aside preview">In this section, you'll create test HTML page in order to:
    <ul>
      <li>Learn about the <code>Selection</code> object and its properties and methods</li>
      <li>Learn about the <code>Range</code> object and its properties and methods</li>
      <li>See how text can be made unselectable</li>
      <li>Learn how to select unselectable text</li>
    </ul>
    <a href="https://github.com/lexogram/openbook/blob/gh-pages/selection/source/zips/03_discover.zip" target="source">Download the source files</a>
  </div>

  <h3>A test page</h3>
  <p>You can start by creating a simple HTML page with a little JavaScript code to show what happens behind the scenes when you select text. You can see what your page will look in Figure 1 below.</p>

  <figure>
  <img src="img/testing.png" alt="Testing a text selection across nodes" />
  <figcaption>Figure 1. Testing a text selection across nodes</figcaption>
  </figure>

  <p>There are a number of things to notice here:</p>
  <ul>
   <li>The HTML includes nodes of different types: <code>&lt;p&gt;</code>, <code>&lt;div&gt;</code>, <code>&lt;span&gt;</code> and <code>&lt;em&gt;</code> tags</li>
   <li>The text uses different writing scripts: Cyrillic, Latin and Thai. In Thai, spaces indicate the end of clauses or sentences (like <code>,</code> and <code>.</code> characters in English). In other words, spaces do not indicate the ends of words. In order to select "the word under the mouse" in Thai (and many other writing scripts) you'll have to learn a technique that doesn't depend on spaces.</li>
   <li>One span in the text is intended to be "unselectable", but when you create a selection that starts before and finishes after this span, it is included in the selection.</li>
   <li>The text of the <code>p#output</code> element at the bottom cannot be selected, to prevent an endless loop where it would try to display the contents of itself inside itself.</li>
   </ul>

   <p>To test this yourself, create a file named <code>index.html</code> in the folder of your choice, enter the HTML code shown below, and save your file.</p>

  <h4><code>index.html</code></h4>
  <pre>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;title&gt;Selection&lt;/title&gt;
  &lt;style&gt;
    .box {
      width: 80%;
      margin: 0 auto;
      border: 1px solid #ccc;
      border-top-color: #666;
      border-left-color: #666;
      background-color: #f8f8f8;
      padding: 0.5em;
    }
    span {
      color: #c00;
    }
    .unselectable {
      -webkit-touch-callout: none; /* iOS Safari */
      -webkit-user-select: none;   /* Chrome/Safari/Opera */
      -khtml-user-select: none;    /* Konqueror */
      -moz-user-select: none;      /* Firefox */
      -ms-user-select: none;       /* Internet Explorer/Edge */
      user-select: none;  
      color: #999;
    }
  }
  &lt;/style&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;p lang="ru"&gt;Вим ед путант альбюкиюс прёнкипыз, квюо
  эи выльёт аэтырно бландит, видэ фабыллас майыжтатйж прё экз.&lt;/p&gt;

  &lt;div class="box" lang="la"&gt;
    &lt;span&gt;Lorem ipsum dolor sit amet, consectetur adipiscing
    elit.&lt;/span&gt;
    In nunc ipsum, tristique in convallis non, ultrices sed eros.
    &lt;span class="unselectable"&gt;This span has
    &lt;em&gt;user-select: none;&lt;/em&gt; applied to it.&lt;/span&gt;
    &lt;span&gt;Integer eu dignissim justo, eu facilisis est.&lt;/span&gt;
  &lt;/div&gt;

  &lt;p lang="th"&gt;คนึงครวญคร่ำถวิลกินระกำ ระกำกินถวิลคร่ำครวญคนึง&lt;/p&gt;

  &lt;p id="output" class="unselectable"&gt;&lt;/p&gt;

  &lt;script src="js/selection.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>

  <p>Now you can create a folder named <code>js</code> alongside your <code>index.html</code> file, create a file named <code>selection.js</code> inside this new folder, enter the JavaScript code as shown below, and save your file. The methods and properties of the <code>Selection</code> and <code>Range</code> objects are shown in red.</p>

  <h4><code>js/selection.js</code></h4>
  <pre>"use strict"

;(function selection(){
  var pOutput = document.getElementById("output")
  var selection = <span class="red">window.getSelection()</span>

  ;(function showSelection(){
    var output = "rangeCount: " + <span class="red">selection.rangeCount</span>
    var range
    var text

    if (<span class="red">selection.anchorNode</span>) {
      text = '"' + selection.anchorNode.textContent + '"'
      output += "&lt;br /&gt;anchorNode: " + text

      output += "&lt;br /&gt;anchorOffset: " + <span class="red">selection.anchorOffset</span>

      text = '"' + <span class="red">selection.focusNode</span>.textContent + '"'
      output += "&lt;br /&gt;focusNode: " + text

      output += "&lt;br /&gt;focusOffset: " + <span class="red">selection.focusOffset</span>
    }

    if (selection.rangeCount) {
      range = <span class="red">selection.getRangeAt(0)</span>

      text =  '"' + <span class="red">range.startContainer</span>.textContent + '"'
      output += "&lt;br /&gt;range.startContainer: " + text

      output += "&lt;br /&gt;range.startOffset: " + <span class="red">range.startOffset</span>

      text =  '"' + <span class="red">range.endContainer</span>.textContent + '"'
      output += "&lt;br /&gt;range.endContainer: " + text

      output += "&lt;br /&gt;range.endOffset: " + <span class="red">range.endOffset</span>

      text = '"' + <span class="red">range.toString()</span> + '"'
      output += "&lt;br /&gt;range.toString(): " + text
    }

    text = '"' + <span class="red">selection.toString()</span> + '"'
    output += "&lt;br /&gt;selection.toString(): " + text

    pOutput.innerHTML = output

    setTimeout(showSelection, 250)
  })()
})()</pre>

  <p class="aside tip">You can test a working version <a href="source/03_discover/">here</a>.</p>

  <h3><code>window.getSelection()</code></h3>
  <p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/getSelection"><code>getSelection()</code></a> method is global: you don't actually need to use <code>window.</code> before you use it. This command returns a live <code>Selection</code> object. The values stored in the <code>Selection</code> object update in real time as you drag the mouse to change your selection.</p>

  <h3>The <code>Selection</code> object</h3>
  <p>You can see all the properties of the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection"><code>Selection</code></a> object by typing the command <code>getSelection()</code> in the Developer Tools' Console window:</p>

  <figure>
  <img src="img/getSelection.png" alt="Displaying the properties of the Selection object in the Console" />
  <figcaption>Figure 2. Displaying the properties of the Selection object in the Console</figcaption>
  </figure>

  <p>The <code>isCollapsed</code> property indicates if a selection is visible or not. It will be <code>true</code> if there is no current selection. If the one or more characters are selected, like <span class="select">this</span>, then <code>isCollapsed</code> will be <code>false</code>.</p>

  <p class="aside note">The <code>baseNode</code>, <code>baseOffset</code>, <code>extendNode</code> and <code>extendOffset</code> properties may not be present in your browser. In Chrome, they are aliases for the <code>anchor...</code> and <code>focus...</code> properties. The <code>type</code> property is also non-standard. In Webkit browsers, if <code>isCollapsed</code> is true, it can take the values "None" (before any selection is made), "Caret" (if there is no current visible selection); if <code>isCollapsed</code> is false, it will take the value "Range".</p>

  <h3><code>showSelection</code></h3>
  <p>The custom <code>showSelection</code> calls itself every 250 milliseconds, in order to update the contents of the <code>p#output</code> element in real time, as you modify the selection. Click somewhere on the page and drag the mouse, to see feedback from the <code>Selection</code> object.</p>

  <h3><code>anchorNode</code> and <code>focusNode</code></h3>
  <p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/anchorNode"><code>anchorNode</code></a> is a pointer to the HTML node where you click the mouse to start your selection. The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/focusNode"><code>focusNode</code></a> is a pointer to the HTML element under the mouse while you are dragging. This may be the same as <code>anchorNode</code>.</p>
  <p class="aside note">In the <code>p#output</code> element, it's the <code>textContent</code> property of these nodes that is shown, not the HTML node object itself.</p>

  <h3>Unselectable text</h3>
  <p>You can apply a CSS rule to any HTML element to make its contents unselectable. The <code>.unselectable</code> class has this rule, which copes with most browsers in existence.</p>
<pre>.unselectable {
  -webkit-touch-callout: none; /* iOS Safari */
  -webkit-user-select: none;   /* Chrome/Safari/Opera */
  -khtml-user-select: none;    /* Konqueror */
  -moz-user-select: none;      /* Firefox */
  -ms-user-select: none;       /* Internet Explorer/Edge */
  user-select: none;  
}</pre>
  <p>If you're targetting recent browsers (from IE10 and later) then you can probably get away with just using:</p>
<pre>.unselectable {
  user-select: none;  
}</pre>
  <p>This class is applied to the sentence that says "<span class="aaa">This span has <em>user-select: none</em> applied to it,</span>". Note what happens if you click on this sentence and drag the mouse upwards or downwards.</p>
  <dl>
    <dt>Click on <span class="aaa"><em>none</em></span> and drag up:</dt>
    <dd>The <code>anchorNode</code> will be the one containing "<span class="aaa"> applied to it</span>", not the <code>&lt;em&gt;</code> element that you initially clicked on. The <code>focusNode</code> will be the HTML node under the mouse.</dd>
    <dt>Click on <span class="aaa"><em>none</em></span> and drag down:</dt>
    <dd>The <code>anchorNode</code> will be the <code>textNode</code> containing the space between "<span class="aaa">it.</span>" and "Integer". In other words: the first selectable node that follows the unselectable node.</dd>
    <dt>Click on <span class="aaa"><em>none</em></span> and drag over the unselectable phrase:</dt>
    <dd>Both the <code>anchorNode</code> and the <code>focusNode</code> will be the <code>textNode</code> containing the space following the unselectable node.</dd>
  </dl>

  <h3>The <code>Range</code> object</h3>
  <p>The <code>Range</code> object is now the official way to deal with multiple arbitrary chunks of an HTML page.</p>
  <p class="aside warn">Older browsers may not support the <code>Range</code> object. If you need to support older browsers then you might prefer to abandon this tutorial and start <a href="http://www.quirksmode.org/dom/range_intro.html">exploring on your own</a>.</p>

  <p>Before you click on a freshly loaded page, the <code>Selection</code> object will contain no <code>Range</code> objects, and the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/rangeCount"><code>selection.rangeCount</code></a> will return 0. When you click the first time, a <code>Range</code> object will be created, and <code>selection.rangeCount</code> will become <code>1</code>, even if no selection is visible.</p>
  <p class="aside note">It's thus important to check whether <code>selection.rangeCount</code> is greater than zero before using <code>var range = selection.<a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/getRangeAt">getRangeAt(0)</a></code> to obtain the <code>Range</code> object. Using an invalid index for the <code>.getRangeAt(...)</code> call will provoke an error.</p>
  <p>By default, the <code>Selection</code> object normally only contains a single <code>Range</code>. However, as you will see, you can use JavaScript to add other ranges to the user-created selection.</p>

  <h3>The <code>toString()</code> method</h3>
  <p>Both the <code>Selection</code> object and the <code>Range</code> object have a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/toString"><code>toString()</code></a> method which returns the text content of the selected chunk referred to by the object. When a selection has only one range, then both will return exactly the same string.</p>
  <p>Note that you can include "unselectable" text in a selection, by sandwiching the unselectable text with text from selectable nodes.</p>
  <dl>
    <dt>Click on the first word in the box (Lorem) and drag to the last word in the box (est)</dt>
    <dd>The <code>anchorNode</code> and <code>focusNode</code> will be what you should expect, but the values returned by <code>.toString()</code> will include the unselectable text.</dd>
    
  </dl>

  <h3>The <code>startContainer</code> and <code>endContainer</code> properties</h3>
  <p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/startContainer"><code>startContainer</code></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/endContainer"><code>endContainer</code></a> properties of a range are similar to the <code>anchorNode</code> and <code>focusNode</code> properties of the <code>Selection</code> object, except they are always set in the order in which the text appears in the source HTML.</p>
  <dl>
    <dt>Click on the last word in the box (est) and drag to the last word in the box (Lorem)</dt>
    <dd>This time, you are starting at the end and dragging backwards: the <code>range.startContainer</code> will contain a pointer to the earlier <code>focusNode</code> and the <code>range.endContainer</code> will contain a pointer to the later <code>anchorNode</code>. This means that you can be sure of the order of the words on the page in your selection.</dd>
  </dl>

  <h3>The <code>...Offset</code> properties</h3>
  <p>The <code>anchorNode</code>, <code>focusNode</code>, <code>startContainer</code> and <code>endContainer</code> properties all have their associated <code>...Offset</code> proprties, which indicate where the boundary between non-selection and selection occurs in the particular HTML node. Below, you'll find links where you can read about these in furthur detail:</p>
  <ul>
    <li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/anchorOffset">anchorOffset</a></li>
    <li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/focusOffset">focusOffset</a></li>
    <li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/startOffset">startOffset</a></li>
    <li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/endOffset">endOffset</a></li>
  </ul>
  <p>You'll get a chance to work with these properties in the coming sections.</p>
  
  <h3>Putting it all together</h3>
  <p>Imagine the following HTML:</p>
<pre>&lt;blockquote&gt;&lt;p&gt;I have called this principle &lt;span&gt;...&lt;/span&gt; 
Natural Selection.&lt;/p&gt;
&lt;footer&gt;Charles Darwin&lt;/footer&gt;&lt;/blockquote&gt;</pre>
  <p>Imagine that you click between the "D" and the "a" of "Darwin" and drag your mouse upwards and release it between the two "ll"s of "called", to make the selection shown below:</p>
  <figure>
  <img src="img/natural.png" alt="The properties of a Selection" />
  <figcaption>Figure 3. The properties of a Selection</figcaption>
  </figure>
  <p>Here are the values that you will obtain:</p>
  <ul>
  <li><code>anchorNode.textContent</code>: "Charles Darwin"</li>
  <li><code>anchorNode</code>: 9</li>
  <li><code>focusNode.textContent</code>: "I have called this principle"</li>
  <li><code>focusOffset</code>: 11</li>
  </ul>
  <ul>
  <li><code><span class="ymmv">range</span>.startContainer.textContent</code>: "I have called this principle"</li>
  <li><code><span class="ymmv">range</span>.startOffset</code>: 11</li>
  <li><code><span class="ymmv">range</span>.endContainer.textContent:</code> "Charles Darwin"</li>
  <li><code><span class="ymmv">range</span>.endOffset</code>: 9</li>
  </ul>

  <div class="aside next">In this section, you've seen the basics about how text selections are treated in JavaScript.
    <ul>
      <li>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection">Selection</a> object
        <ul>
          <li><span class="ymmv">window.</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/getSelection">getSelection()</a></li>
          <li><span class="ymmv">selection.</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/anchorNode">anchorNode</a></li>
          <li><span class="ymmv">selection.</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/anchorOffset">anchorOffset</a></li>
          <li><span class="ymmv">selection.</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/focusNode">focusNode</a></li>
          <li><span class="ymmv">selection.</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/focusOffset">focusOffset</a></li>
          <li><span class="ymmv">selection.</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/rangeCount">rangeCount</a></li>
          <li><span class="ymmv">selection.</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/getRangeAt">getRangeAt()</a></li>
          <li><span class="ymmv">selection.</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/toString">toString()</a></li>
          <li><span class="ymmv">selection.</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/isCollapsed">isCollapsed</a></li>
        </ul>
      </li>
      <li>The <a href="">Range</a> object
        <ul>
          <li><span class="ymmv">range.</span><a href="">startContainer</a></li>
          <li><span class="ymmv">range.</span><a href="">startOffset</a></li>
          <li><span class="ymmv">range.</span><a href="">endContainer</a></li>
          <li><span class="ymmv">range.</span><a href="">endContainer</a></li>
          <li><span class="ymmv">range.</span><a href="">endOffset</a></li>
          <li><span class="ymmv">range.</span><a href="">toString()</a></li>
        </ul>
      </li>
      <li>How a text selection is expressed in terms of its start and end points.</li>

    </ul>
    <p>In the <a href="#hyphens">next section</a>, you'll see how to extend a selection so that a single click can be used to select the whole of a hyphenated word.</p>
  </div>

  <footer>
    <ul class="nav">
      <li>
        <a href="#hyphens">
         <img src="../img/arrow.png" alt="next"/>
        </a>
      </li>
    </ul>
  </footer>
</section>

<!-- WHOLE WORD -->
<section id="hyphens">
  <h2>Selecting the whole word</h2>
  <p>As of August 2016, none of the major browsers (Chrome, Firefox, IE, Opera, Safari) allow you to select a hyphenated word with a double-click. The default behaviour is to select only the word that was clicked, or the hypen.</p>
  <div class="aside preview">In this section, you'll learn how to:
    <ul>
      <li>Ensure that when you double-click to make a selection, hyphenated words are fully selected</li>
      <li>Modify the selection by manipulating the <code>Range</code> object and its <code>startOffset</code> and <code>endOffset</code> properties.</li>
      <li>Use a simple regular expression to detect word boundaries</li>
      <li>Search backwards with a regular expression</li>
      <li>Refine your regular expression so that it works with all European languages.</li>
    </ul>
    <a href="https://github.com/lexogram/openbook/blob/gh-pages/selection/source/zips/04_hyphens.zip" target="source">Download the source files</a>
  </div>

  <h3>Modifying a <code>Range</code></h3>
  <p>As soon as you click on a web page, the window's <code>Selection</code> object will possess a <code>Range</code> object. You can manipulate the <code>startOffset</code> of the Range's <code>startContainer</code> and the <code>endOffset</code> of its <code>endContainer</code>, to move them out to nearest word boundaries, but simply modifying the <code>Range</code> object will not be enough to change the visible selection on the page: you will also have to remove the <code>Range</code> object from the <code>Selection</code> and then add it back again, so that the <code>Selection</code> object becomes aware that it has changed.</p>

  <h3>Defining the problem</h3>
  <p>By default, a click on a browser page will create an anchor point for a selection; if you drag the mouse, you can extend the selection forwards or backwards form the anchor point. If you double-click, you switch to "whole word mode"; as you drag your mouse, the selection will select whole words and the whole non-word spaces between them. With this default technique, selecting a hyphenated word requires a composite action: a (double-)click followed by a drag and release. If it makes sense for your users to select hyphenated words whole by default, you can add a patch that will  save your users time and reduce their risk of carpal tunnel syndrome.</p>
  <p>The trick is to:</p>
  <ul>
   <li>Detect if the current word contains a hyphen</li>
   <li>If so, extend the current selection backwards to the preceding word boundary and forwards to the next word boundary.</li>
  </ul>
  <p>This poses three questions:</p>
  <ul>
  <li>How do you detect that a word contains a hyphen?</li>
  <li>How do you define a word boundary?</li>
  <li>How do you extend a selection?</li>
  </ul>

  <h3>Using Regular Expressions</h3>
  <p>Regular Expressions are designed to let you search for a particular pattern in a string of text. If you're not familiar with Regular Expressions, you might like to work through a <a href="http://regexone.com/">beginner's tutorial</a> so that the explanations below make more sense to you.</p>
  <p>The example below uses three regular expressions. Here's the simplest: <code>/\w/</code>. This means "match the first <span class="keyword">word character</span> in the string". According to the <a href="</span>  ">JavaScript specifications</a>, a word character is any of the following:</p>
  <pre>0123456789_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz
</pre>
  <p>That's fine if you're working in English and not using any of them fancy foreign words with accents, like "déjà vu" or "mañana". You can use this simple expression for now, for testing the logic of your code, and then create a more generic regular expression when you've got everything working in plain vanilla English.</p>

  <p>The other two regular expressions used are more complicated. For example:</p>
  <pre>var endRegex = /^-('?-?\w+)+/</pre>
  <p>Here's what it means</p>
  <dl>
    <dt><code>^</code></dt>
    <dd>Starting from the beginning of the string ...</dd>
    <dt><code>-</code></dt>
    <dd>... find one a hypen ...</dd>
    <dt><code>(<span class="ymmv">...</span>)+</code></dt>
    <dd>... followed by one or more sequences ...</dd>
   <dt><code>'?-?\w+</code></dt>
    <dd>... of optional apostrophes and hyphens and ending with one of more word characters</dd>
  </dl>
  <p>In summary, this means: <em>look for the longest chunk like "-to-day" or "-friend's", that starts with a hyphen, may include more hyphens and apostrophes, and ends with a letter or a number.</em> If the string you are searching in starts with "no hyphens", then nothing will match.</p>
  <p>The other regex you can use for now is:</p>
  <pre>/(\w+'?-?)+-$/g</pre>
  <p>This uses similar techniques to say: <em>look for the longest chunk that starts with a word character, may include some hyphens and apostrophes, and ends with a hyphen</em>. The final <code>g</code> means: after you've found this pattern, keep looking for more.</p>

  <p class="aside warn">It's easy to create a regular expression that matches everywhere, in which case the <code>while</code> statement in the code listing below will never stop being <code>true</code>, and the browser will freeze. This shouldn't happen with the regular expressions used in this tutorial. If you change the <code>startRegex</code> expression and the browser stops responding, then the best solution is to force quit your browser, and restart it without restoring the previous session. Fix your script before you reload your page.</p>

  <p>Below, you'll find new code to add to your <code>js/selection.js</code> file:</p>

  <h4><code>js/selection.js</code></h4>
  <pre><span class="revised">"use strict"

;(function showSelection(){
  <span class="omit">// code omitted for clarity</span>
})()</span>


;(function selectWholeWordsWithHyphens(){
  var selection = window.getSelection()
  <span class="comment">// Regex designed to find a word+hyphen before the selected word.
  // Example: ad-|lib|
  // It finds the last chunk with no non-word characters (except for
  // ' and -) before the first selected character.</span> 
  var startRegex = /(\w+'?-?)+-$/g
  <span class="comment">// Regex designed to find a hyphen+word after the selected word.
  // Example: |ad|-lib</span>
  var endRegex = /^-('?-?\w+)+/
  <span class="comment">// Edge case: check if the selection contains no word characters.
  // If so, then don't do anything to extend it.</span>
  var edgeRegex = /\w/

  document.body.ondblclick = selectHyphenatedWords

  function selectHyphenatedWords(event) {
    if (!selection.rangeCount) {
      return
    }
    var range = selection.getRangeAt(0)
    var container = range.startContainer
    var string = container.textContent
    var selectionUpdated = false

    if (string.substring(range.startOffset, range.endOffset)
              .search(edgeRegex) < 0) {
      <span class="comment">// There are no word characters selected</span>
      return
    }

    extendSelectionBackBeforeHypen(string, range.startOffset)
    extendSelectionForwardAfterHyphen(string, range.endOffset)

    if (selectionUpdated) {
      selection.removeAllRanges()
      selection.addRange(range)
    }

    function extendSelectionBackBeforeHypen(string, offset) {
      var lastIndex = 0
      var result
        , index
      string = string.substring(0, offset)

      while (result = startRegex.exec(string)) {
        index = result.index
        lastIndex = startRegex.lastIndex
      }

      if (lastIndex === offset) {
        range.setStart(container, index)
        selectionUpdated = true
      }
    }

    function extendSelectionForwardAfterHyphen(string, offset) { 
      if (!offset) {
        return
      }

      string = string.substring(offset)
      var result = endRegex.exec(string)

      if (result) {
        range.setEnd(container, offset + result[0].length)
        selectionUpdated = true
      }
    }
  }
})()</pre>

  <h3>All in one place</h3>
  <p>Because this function is triggered by a double-click, you can be sure that the click occurred with no movement, so the <code>range.startContainer</code> and <code>range.endContainer</code> will be the same. The browser will already have selected the item under the mouse. This might in fact be a space, a punctuation character, or a "word" in English or some other language.</p>
  <p>If something other than a word is selected, there is no point in searching for a hypen in the non-word. The first check is therefore to see if there are any word characters included in the selectionA if not, there is no need to go any further:</p>
  <pre>if (string.substring(range.startOffset, range.endOffset)
          .search(edgeRegex) < 0) {
  return
}</pre>

  <h3>Extending the selection</h3>
  <p>If you click on a word, there are four possibilities:</p>
  <ul>
  <li>The word contains no hyphens: there is nothing more to do</li>
  <li>You double-clicked on the hyphen itself and selected it. To simplify this tutorial, you can ignore this possibility.</li>
  <li>You clicked after the first hyphen in a word, so only the part of the word before the hyphen is selected: you need to extend the selection back to the beginning of the word.</li>
  <li>You clicked before a hyphen in a word, so only the part of the word before the hyphen is selected: you need to extend the selection to the end of the word</li>
  </ul>
  <p>In a word like "day-to-day", if you double-click on "to", then your code needs to extend the selection both forwards and backwards.</p>

  <h3>Extending the selection to the end of the word</h3>
  <p>Extending from the end of the current selection to end of the word is the easier problem to solve, so you can start by looking at that. The technique is to  remove all the characters in the <code>textContent</code> string before the end of the current selection, then check if the remaining characters start with a <code>-</code> followed by an apostrophe or a word character, as defined in <code>endRegex</code>: <code>/^-('?-?\w+)+/</code></p>

  <pre>function extendSelectionForwardAfterHyphen(string, offset) { 
  string = string.substring(offset)
  var result = endRegex.exec(string)

  if (result) {
    range.setEnd(container, offset + result[0].length)
    selectionUpdated = true
  }
}</pre>

  <p>If there is a match, <code>result</code> will be an array containing the matching string. The <code>length</code> of this string determines the distance from the end of the current selection (<code>offset</code>) to the end of the hyphenated word.</p>
  <p>You can use <a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/setEnd"><code>range.setEnd</code></a> to move the end of the selection, but this is not enough to update the selection on the screen. Setting the <code>selectionUpdated</code> flag to <code>true</code> will tell your code to perform a necessary second step in just a moment.</p>

  <h3>Extending the selection back to the beginning of the word</h3>
  <p>Finding the beginning of a hyphenated word is not quite so simple, because in JavaScript, regular expressions can only look forwards, not backwards. A good workaround is to look for <em>all</em> the matches for a string like "xxx-" that occur before the beginning of the current selection, then to test if the <em>last</em> of these matches ends exactly at the selection point. If so, the beginning of that last match indicates the beginning of the hyphenated word.</p>
  <p>When a regular expression object, such as <code>startRegex</code>, is first created, its <code>lastIndex</code> property is set to <code>0</code>. Each time its <code>exec</code> method is called  and a match is found, <code>lastIndex</code> is updated to reflect the position of the end of the match. The next time <code>exec</code> is called, it will start searching for a new match from that point. If the last value of <code><span class="ymmv">regex.</span>lastIndex</code> is <code>offset</code> , then the <code>index</code> property of the <code>results</code> array gives the starting point of the hyphenated word. In this case, you can use the <code><span class="ymmv">range.</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/setStart">setStart</a></code> method to move the begining of the selection to the beginning of the word:</p>
  <pre>function extendSelectionBackBeforeHypen(string, offset) {
  var lastIndex = 0
  var result
    , index
  string = string.substring(0, offset)

  while (result = startRegex.exec(string)) {
    index = result.index
    lastIndex = startRegex.lastIndex
  }

  if (lastIndex === offset) {
    range.setStart(container, index)
    selectionUpdated = true
  }
}</pre>

  <p>If <code>selectionUpdate</code> is set to <code>true</code>,  because the selection has been extended either forwards or backwards or both, then the <code>Selection</code> range needs to be updated:</p>
  <pre>if (selectionUpdated) {
  selection.removeAllRanges()
  selection.addRange(range)
}</pre>

  <h3>Testing</h3>
  <p>Your current <code>index.html</code> page contains hyphenated words only in the unselectable section. To test your new function, you can add the following to your HTML file:</p>

  <pre class="revised">&lt;!DOCTYPE html&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  <span class="omit">// HTML omitted for clarity</span>
&lt;/head&gt;

&lt;body&gt;
  <span class="omit">// HTML omitted for clarity</span>

  <span class="new">&lt;p&gt;-Double-click to test- 'Use A4-size paper.'
  It's a three-o'clock meet-up. An O'Brian-style decision.
  Я — программист. «Ты говоришь по-русски? Скажи что-нибудь.»&lt;/p&gt;</span>

  &lt;p lang="th"&gt;งมเข็มในมหาสมุทร พูดไปสองไพเบี้ย นิ่งเสียตำลึงทอง
  ตากลม ตา&#8203;กลม&lt;/p&gt;

  &lt;p id="output" class="unselectable">&lt;/p&gt;

  &lt;script src="js/selection.js">&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</span></pre>
  <p>You can save the changes that you have made to <code>selection.js</code> and <code>index.html</code> and relaunch the page in your browser. Try clicking on hyphenated words, on hyphens and other punctuation, and on blank spaces between words, to see what happens.</p>
  <p class="aside tip">You can test a working version <a href="source/04_hyphens_w/">here</a>.</p>
  <figure>
  <img src="img/selection.png" alt="Composite image showing 3 selections. Hyphenated words in English are selected whole." />
  <figcaption>Figure 4. Composite image showing 3 selections. Hyphenated words in English are selected whole.</figcaption>
  </figure>

  <p>As you can see in Figure 4 above, this solution is not yet perfect. Hyphens in words in other writing scripts (Russian in the example) are not treated the same way as hyphenated words in English.</p>

  <h3>Revising the "word character" regular expression</h3>
  <p>The simple regular expression <code>/\w/</code>, meaning "word character" works well for most text in English, but it fails in languages that use accented Roman characters and in non-Roman scripts. In JavaScript, it is a shorthand for <code>/[0-9A-Za-z_]/</code>. When working in other languages, what you need is an expression that means "any printable character in the ASCII table that is not (not a letter or a number)". Here are all the printable ASCII characters:</p>
  <pre>! " # $ % &amp; ' ( ) * + , - . / 
0 1 2 3 4 5 6 7 8 9 
: ; < = > ? @ 
A B C D E F G H I J K L M N O P Q R S T U V W X Y Z 
[ \ ] ^ _ ` 
a b c d e f g h i j k l m n o p q r s t u v w x y z 
{ } ~</pre>
  <figcaption>Figure 5: The printable ASCII characters</figcaption>
  <p>To refer to a range of characters for a regular expression pattern, such as "all the letters from A to Z" you can use a pattern like <code><span class="ymmv">/[</span>A-Z<span class="ymmv">]/</span></code>. Some characters, such as <code>/</code> have a special meaning in regular expressions, so to refer to that character as a character, you need to <span class="keyword">esape</span> it by placing a <code>\</code> in front of it. The expression <code>/[!-\/]/</code> will match all the characters from <code>!</code> to <code>/</code> (which needs to be escaped). This corresponds to the top line in the character set shown in Figure 5 above. You can put several ranges one after the other inside the square brackets, so the expression <code>/[!-\/:-@[-`{-~]/</code> will match any printable ASCII character other than a letter or a number.</p>
  <p>You can use the <code>^</code> special character to say "not any of the following characters". So <code>/[^!-\/:-@[-`{-~]</code></code> means "any character that is not one of the following: !"#$%&amp;'()*+,-./:;<=>?@[\]^_`{}~"</p>

  <h3>Unicode characters for punctuation</h3>
  <p>Even in English, characters outside the ASCII range, such as
  <code>“ ” ‘ ’ …</code> are often used for punctuation. In Russian, quoted speech is shown with guillemets characters: <code>« »</code>. These sets of punctuation marks are contained in two different Unicode blocks: <a href="https://en.wikipedia.org/wiki/List_of_Unicode_characters#Latin-1_Supplement">Latin-1 Supplement</a> and <a href="https://en.wikipedia.org/wiki/List_of_Unicode_characters#Unicode_symbols">Unicode Symbols</a> . The Latin-1 supplements block starts with the non-breaking space, which you might know in HTML terms as <code>&amp;nbsp;</code> and which you can('t) see here: <code>&nbsp;</code>. Putting a blank space in your regular expression can make it difficult to understand, so you might prefer to use the Unicode control code: <code>\u00A0</code> Indeed, you might want to use Unicode control characters to show that you are selecting a whole Unicode block. You can add these two Unicode blocks to your "non word character" expression like this:</p>
  <pre>/[!-\/:-@[-`{-~<span class="new">\u00A0-\u00BF\u2013-\u204A</span>]/</pre>
  <p>... or ...</p>
  <pre>/[!-\/:-@[-`{-~<span class="new">\u00A0-¾―-⁊</span>]/</pre>

  <h3>Matching whitespace</h3>
  <p>All the ASCII characters that create a space on the page but which do not print can be expressed in a regular expression as <code>\s</code>. These characters include:</p>
  <ul>
  <li>space</li>
  <li>carriage return</li>
  <li>line feed</li>
  <li>tab</li>
  </ul>
  <p>To say "all characters except those from European languages that are never found in European words" you can write:</p>
  <pre>/[^\s!-\/:-@[-`{-~\u00A0-\u00BF\u2013-\u204A]/</pre>
  or
  <pre>/[^\s!-\/:-@[-`{-~\u00A0-¾—-⁊]/</pre>
  <p class="aside note">To be applicable to all languages, even outside Europe, a rigorous regular expression would need to include all the punctuation and other non-word characters in any script, such as <code>๏ ๛ 。</code>. In practice, it would make more sense to generate a language-specific regular expression, to match just the languages you expect to encounter.</p>

  <pre class="revised">"use strict"

;(function showSelection(){
  <span class="omit">// code omitted for clarity</span>

;(function selectWholeWordsWithHyphens(){
  var selection = window.getSelection()
  // Regex designed to find a word+hyphen before the selected word.
  // Example: ad-|lib|
  // It finds the last chunk with no non-word characters (except for
  // ' and -) before the first selected character. 
  var startRegex = /(<span class="new">[^\s!-\/:-@[-`{-~\u00A0-¾—-⁊]</span>+'?-?)+['-]$/g
  // Regex designed to find a hyphen+word after the selected word.
  // Example: |ad|-lib
  var endRegex = /^['-]('?-?<span class="new">[^\s!-\/:-@[-`{-~\u00A0-¾—-⁊]</span>+)+/
  // Edge case: check if the selection contains no word characters.
  // If so, then don't do anything to extend it.
  var edgeRegex = /<span class="new">[^\s!-\/:-@[-`{-~\u00A0-¾—-⁊]</span>/

  <span class="omit">// code omitted for clarity</span>
})()</span></pre>

  <h3>Testing the refined regular expression</h3>
  <p>You can now test whether the new regular expression will correctly detect words with hyphens in Russian as well as English.</p>

  <p class="aside tip">You can test a working version with the revised regular expression<a href="source/04_hyphens/">here</a>.</p>

  <div class="aside next">In this section, you've:
    <ul>
      <li>Seen how to find the beginning and end of words that contain a hyphen.</li>
      <li>Manipulated a <code>Range</code> object to modify the current selection</li>
    </ul>
    <p>In particular you have seen:</p>
    <ul>
    <li><code>Selection</code> object
      <ul>
        <li><code><span class="ymmv">selection.</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/removeAllRanges">removeAllRanges</a></code></li>
        <li><code><span class="ymmv">selection.</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Selection/addRange">addRange</a></code></li>
      </ul>
    </li>
    <li><code>Range</code> object
      <ul>
        <li><code><span class="ymmv">range.</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/setStart">setStart</a></code></li>
        <li><code><span class="ymmv">range.</span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/setEnd">setEnd</a></code></li>
      </ul>
    </li>
    <li><code>RegExp</code> object
      <ul>
        <li><code><span class="ymmv">regex.</span><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/exec">exec</a>(string)</code></li>
        <li><code><span class="ymmv">string.</span><a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/String/search">search</a>(regex)</code></li>
      </ul>
    </li>
    </ul>
    <p>In the <a href="#jump">next section</a>, you will learn to make the selection jump from one word to the next using the arrow keys.</p>
  </div>

  <footer>
    <ul class="nav">
      <li>
        <a href="#jump">
         <img src="../img/arrow.png" alt="next"/>
        </a>
      </li>
    </ul>
  </footer>
</section>

<!-- JUMP -->
<section id="jump">
  <h2>Jumping to the next word with a keyboard shortcut</h2>
  <div class="aside preview">In this section, you'll learn how to:
    <ul>
      <li>Do stuff</li>
    </ul>
    <a href="https://github.com/lexogram/openbook/blob/gh-pages/selection/source/zips/05_jump.zip" target="source">Download the source files</a>
  </div>

  <h3>Subsection</h3>
  <p>Stuff goes here</p>

  <div class="aside next">In this section, you've ...
    <ul>
      <li>Done things</li>
      <li>Learnt ideas</li>
    </ul>
    <p>In the <a href="#box">next section</a>, you'll ....</p>
  </div>

  <footer>
    <ul class="nav">
      <li>
        <a href="#box">
         <img src="../img/arrow.png" alt="next"/>
        </a>
      </li>
    </ul>
  </footer>
</section>

<!-- BOX -->
<section id="box">
  <h2>Limiting the "whole word selection" feature to one HTML element</h2>
  <div class="aside preview">In this section, you'll learn how to:
    <ul>
      <li>Do stuff</li>
    </ul>
    <a href="https://github.com/lexogram/openbook/blob/gh-pages/selection/source/zips/CHANGE_MY_NAME.zip" target="source">Download the source files</a>
  </div>

  <h3>Subsection</h3>
  <p>Stuff goes here</p>

  <div class="aside next">In this section, you've ...
    <ul>
      <li>Done things</li>
      <li>Learnt ideas</li>
    </ul>
    <p>In the <a href="#end">next section</a>, you'll ....</p>
  </div>

  <footer>
    <ul class="nav">
      <li>
        <a href="#end">
         <img src="../img/arrow.png" alt="next"/>
        </a>
      </li>
    </ul>
  </footer>
</section>

<!-- NEXT -->
<section id="next">
  <h2>Title of section</h2>
  <div class="aside preview">In this section, you'll learn how to:
    <ul>
      <li>Do stuff</li>
    </ul>
    <a href="https://github.com/lexogram/openbook/blob/gh-pages/selection/source/zips/CHANGE_MY_NAME.zip" target="source">Download the source files</a>
  </div>

  <h3>Subsection</h3>
  <p>Stuff goes here</p>

  <div class="aside next">In this section, you've ...
    <ul>
      <li>Done things</li>
      <li>Learnt ideas</li>
    </ul>
    <p>In the <a href="#end">next section</a>, you'll ....</p>
  </div>

  <footer>
    <ul class="nav">
      <li>
        <a href="#end">
         <img src="../img/arrow.png" alt="next"/>
        </a>
      </li>
    </ul>
  </footer>
</section>

<!-- CONCLUSION -->
<section id="end">
  <h2>Conclusion</h2>
  <div class="aside preview">Here's what you've learnt:
    <ul>
      <li>98% of good stuff</li>
      <li>2% salt</li>
    </ul>
  </div>

  <p>Well done!</p>
</section>

<!-- OVERVIEW : SECTION 0 -->
<section id="top">
  <h2>Overview</h2>
  <p class="top">This tutorial teaches you how to use JavaScript to control the selection of text in a web page.</p>

  <div class="aside preview">In particular, you will be learning about:
    <ul>
      <li>The <code>Selection</code> object</li>
      <li>The <code>Range</code> object</li>
      <li>Selecting the word under the cursor as the user drags the mouse</li>
      <li>Creating <span class="select">discontigous</span> word <span class="select">selections</span></li>
      <li>Working with text in a variety of writing scripts</li>
    </ul>
  </div>

  <footer>
    <ul class="nav">
      <li>
        <a href="#intro">
         <img src="../img/arrow.png" alt="next"/>
        </a>
      </li>
    </ul>
  </footer>
</section>
</article>
</main>

<script src="../js/core.js"></script>
</body>
</html>
